
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function getUserBrandId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.brandId;
    }

    function isUserBrandMember(brandId) {
      return isUserAuthenticated() && getUserBrandId() == brandId;
    }

    // Rules for user profiles
    match /users/{userId} {
      allow read, write: if isUserAuthenticated() && request.auth.uid == userId;
    }

    // Rules for brands
    match /brands/{brandId} {
      // Allow public read for client chat, but restrict writes to brand members.
      allow read: if true;
      allow write: if isUserBrandMember(brandId);
    }
    
    // Rules for contacts
    match /contacts/{contactId} {
      allow read, list: if isUserBrandMember(request.query.brandId) || isUserBrandMember(resource.data.brandId);
      allow create: if isUserBrandMember(request.resource.data.brandId);
      allow update, delete: if isUserBrandMember(resource.data.brandId);
    }

    // Rules for chats and their messages
    match /chats/{chatId} {
      // Allow read/write for brand members or for unauthenticated users on client-chat pages
      allow read, write: if (isUserAuthenticated() && isUserBrandMember(resource.data.brandId)) || 
                           (request.auth == null && resource.data.brandId != null);
      
      match /messages/{messageId} {
        // Allow read/write for brand members or unauthenticated users for messages in accessible chats
        allow read, write: if (isUserAuthenticated() && isUserBrandMember(get(/databases/$(database)/documents/chats/$(chatId)).data.brandId)) ||
                           (request.auth == null && get(/databases/$(database)/documents/chats/$(chatId)).data.brandId != null);
      }
    }
  }
}
